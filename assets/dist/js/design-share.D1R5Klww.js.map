{"version":3,"file":"design-share.D1R5Klww.js","sources":["../../source/js/restApi/endpoints/mediaSideload.ts","../../source/js/utils/isValidFileExtensionFromUrl.ts","../../source/js/utils/isValidUrl.ts","../../source/js/utils/isRemoteMediaFile.ts","../../source/js/utils/valueIsHexString.ts","../../source/js/utils/scrubHexValue.ts","../../source/js/admin/designShareUtils.ts","../../source/js/utils/findUrlsInString.ts","../../source/js/utils/replaceRemoteFilesWithLocalInString.ts","../../source/js/admin/designShare.ts"],"sourcesContent":["import {newEndpoint, NameSpace, ApiCallArgs } from \"../newEndpoint\";\n\nexport interface MediaSideloadArgs extends ApiCallArgs {\n    url: string,\n    return?: 'html'|'src'|'id',\n    description?: string\n}\n\nexport const mediaSideload = newEndpoint<string, MediaSideloadArgs>({\n    nameSpace: NameSpace.MUNICIPIO_V1,\n    route: 'media/sideload',\n    method: 'POST'\n});\n","export const isValidFileExtensionFromUrl = (url:string, extensions: string[]):boolean => {\n    const fileName = url.substring(url.lastIndexOf('/')+1);\n    const fileExtensionsGroup = extensions.join('|')\n    const regex = new RegExp(`\\\\.(${fileExtensionsGroup})(\\\\?.+)?$`)\n\n    return regex.test(fileName)\n}","export const isValidUrl = (test:string):boolean => {\n    try {\n        const url = new URL(test)\n        if(url.origin === 'null') return false\n    } catch {\n        return false;\n    }\n\n    return true;\n}","import { isValidFileExtensionFromUrl } from \"./isValidFileExtensionFromUrl\";\nimport { isValidUrl } from \"./isValidUrl\";\n\nexport const isRemoteMediaFile = (url:any):url is string => {\n    if( typeof url !== 'string' ) return false;\n    if(!isValidUrl(url)) return false;\n    if(!isValidFileExtensionFromUrl(url, ['svg'])) return false\n    \n    return true;\n}","export const valueIsHexString = (value:any):value is string => {\n  return typeof value === 'string' && value.indexOf('#') === 0;\n};","import { valueIsHexString } from \"./valueIsHexString\";\n\nexport const scrubHexValue = (input:any):typeof input => {\n  if (input) {\n    if (typeof input === 'object') {\n      for (const [key, value] of Object.entries(input)) {\n        if (valueIsHexString(value)) {\n          input[key] = value.toLowerCase();\n        }\n      }\n    } else if (valueIsHexString(input)) {\n      input = input.toLowerCase();\n    }\n  }\n\n  return input;\n};\n","import { mediaSideload, MediaSideloadArgs } from \"../restApi/endpoints/mediaSideload\";\nimport { isRemoteMediaFile } from \"../utils/isRemoteMediaFile\";\nimport { scrubHexValue } from \"../utils/scrubHexValue\";\n\nexport async function handleMediaSideload(args: MediaSideloadArgs) {\n    return mediaSideload\n        .call(args)\n        .catch(error => {\n            console.error(error);\n            return null;\n        });\n}\n\nfunction getExcludedSections(): string[] {\n    const defaultSections = ['municipio_customizer_panel_design_module']\n    const excludedSections = wp.customize.control('exclude_load_design').setting.get() as string[]\n    return [...defaultSections, ...excludedSections]\n}\n\nexport function getExcludedSettingIds(): string[] {\n    const excludedSections = getExcludedSections()\n    return Object\n    .entries(wp.customize.settings.controls)\n    .map(([key]) => wp.customize.control(key))\n    .filter(setting => setting !== undefined)\n    .filter(setting => setting.hasOwnProperty(\"params\"))\n    .filter(setting => excludedSections.includes(setting.params.section))\n    .map(setting => setting.id)\n}\n\nexport function getSettingsWithDefaultSetting() {\n    const excludedSettingsIds = getExcludedSettingIds();\n    return Object\n        .entries(wp.customize.settings.settings)\n        .map(([key]) => wp.customize.control(key))\n        .filter(setting => setting !== undefined)\n        .filter(setting => setting.hasOwnProperty(\"params\"))\n        .filter(setting => setting.params.hasOwnProperty(\"default\") && setting.params.hasOwnProperty(\"value\"))\n        .filter(setting => setting.params.type !== \"kirki-custom\")\n        .filter(setting => !excludedSettingsIds.includes(setting.params.id))\n}\n\nexport function resetSettingsToDefault(settings: any[]) {\n    settings.forEach(setting => {\n        wp.customize.control(setting.id).setting.set(setting.params.default);\n    });\n}\n\nexport function themeIdIsValid(id: any): id is string {\n    return typeof id === 'string' && id.length === 32;\n}\n\nexport async function getRemoteSiteDesignData(id: string) {\n    return fetch(`https://customizer.municipio.tech/id/${id}`)\n        .then(response => response.json())\n        .catch(error => {\n            alert(error);\n        });\n}\n\nexport async function migrateRemoteMediaFile(value: string, control: any = null) {\n    const sideloadedMedia = await handleMediaSideload({ url: value, return: 'src' });\n\n    if (control && sideloadedMedia !== null) {\n        control.setting.set(sideloadedMedia);\n    }\n\n    return sideloadedMedia\n}\n\nexport function updateKirkiImageControl(control: any, value: string) {\n    const img = document.querySelector(`.control-section-kirki-default ${control.selector} .attachment-thumb`);\n    if (img !== null) {\n        img.setAttribute('src', value);\n    }\n}\n\ninterface CustomizerNotificationProps {\n    setting: any,\n    code: string,\n    message: string,\n    type?: 'error' | 'warning' | 'notice'\n}\n\nexport function showNotification(args: CustomizerNotificationProps) {\n    const notification = new wp.customize.Notification(args.code, { message: args.message, type: args.type ?? 'notice', dismissible: true });\n    args.setting.notifications.add(args.code, notification);\n}\n\nexport async function getFormattedMods(mods: any, excludedSettings:string[]) {\n    let formattedMods: Record<string, any> = {}\n\n\n    for (const [key, value] of Object.entries(mods)) {\n\n        if( excludedSettings.includes(key) ) {\n            continue\n        }\n\n        if (value !== null && typeof value === 'object' && !Array.isArray(value)) {\n\n            for (const [subKey, subValue] of Object.entries(value)) {\n                formattedMods[`${key}[${subKey}]`] = subValue\n            }\n\n        } else {\n            formattedMods[key] = value\n        }\n    }\n\n    return formattedMods\n}\n\nexport async function importSettings(formattedMods: Record<string, any>, excludedSettings: string[]) {\n    for (const [key, rawValue] of Object.entries(formattedMods)) {\n\n        const control = wp.customize.control(key);\n        const value = Array.isArray(rawValue) ? rawValue.filter(el => el !== null) : rawValue\n\n        if (excludedSettings.includes(key)) {\n            continue;\n        }\n\n        if (value === null) {\n            continue;\n        }\n\n        if (key.startsWith('custom_fonts')) {\n            const fontName = key.match(/\\[(.+)\\]$/)\n            if (fontName === null) continue;\n            await handleMediaSideload({ url: value, description: fontName[1], return: 'id' })\n        } else if (typeof control !== 'undefined') {\n\n            if (isRemoteMediaFile(value)) {\n\n                await migrateRemoteMediaFile(value, control)\n                updateKirkiImageControl(control, value);\n\n            } else {\n                const scrubbedValue = scrubHexValue(value);\n                control.setting.set(scrubbedValue)\n            }\n        }\n    }\n}","import { isValidUrl } from \"./isValidUrl\";\n\n\nexport function findUrlsInString(string: string, origin?:string): string[] {\n    const urlRegex = /(?:(?:https?|ftp|file):\\/\\/|www\\.|ftp\\.)(?:\\([-A-Z0-9+&@#/%=~_|$?!:,.]*\\)|[-A-Z0-9+&@#/%=~_|$?!:,.])*(?:\\([-A-Z0-9+&@#/%=~_|$?!:,.]*\\)|[A-Z0-9+&@#/%=~_|$])/gi;\n    const foundFromRegex = string.match(urlRegex);\n    \n    if (foundFromRegex === null) {\n        return [];\n    }\n\n    const validUrls = foundFromRegex.filter(isValidUrl);\n\n    if( !origin ) {\n        return validUrls\n    }\n\n    const urlsMatchingOrigin = validUrls.filter(urlString => {\n        const url = new URL(urlString)\n        return origin === url.origin\n    })\n\n    return urlsMatchingOrigin\n\n}","import { migrateRemoteMediaFile } from \"../admin/designShareUtils\";\nimport { findUrlsInString } from \"./findUrlsInString\";\n\nexport async function replaceRemoteFilesWithLocalInString(css: string, origin?: string): Promise<string> {\n    const urls = findUrlsInString(css, origin);\n\n    if (urls.length < 1) {\n        return css;\n    }\n\n    for (const url of urls) {\n        const migratedUrl = await migrateRemoteMediaFile(url);\n\n        if (migratedUrl === null) {\n            continue;\n        }\n\n        css = css.replace(url, migratedUrl);   \n    }\n\n    return css;\n}","import { themeIdIsValid, getRemoteSiteDesignData, getSettingsWithDefaultSetting, resetSettingsToDefault, showNotification, getExcludedSettingIds, getFormattedMods, importSettings } from \"./designShareUtils\";\nimport { replaceRemoteFilesWithLocalInString } from \"../utils/replaceRemoteFilesWithLocalInString\";\n\nasync function handleLoadSettingChange(id:any) {\n    \n    const apiResponse = await getRemoteSiteDesignData(id);\n    \n    if( Object.keys(apiResponse.mods).length < 1 ) {\n        throw new Error(\"The selected theme seems to be empty, please select another one.\")\n    }\n    \n    const settingsWithDefaultSetting = getSettingsWithDefaultSetting()\n    const excludedSettings = getExcludedSettingIds();\n    const formattedMods = await getFormattedMods(apiResponse.mods, excludedSettings)\n    resetSettingsToDefault(settingsWithDefaultSetting)\n    importSettings(formattedMods, excludedSettings)\n\n    if( !excludedSettings.includes('custom_css') ) {\n        try {\n            const dataUrl = new URL(apiResponse.website)\n            const sanitizedCss = await replaceRemoteFilesWithLocalInString(apiResponse.css ?? '', dataUrl.origin)\n            wp.customize.control('custom_css').setting.set(sanitizedCss);\n        } catch (error) {\n            throw new Error(\"Failed migrating css from source.\")\n        }\n    }\n}\n\nexport default (() => {\n    if(!wp.customize) return\n    \n    wp.customize.bind('ready', () => {\n        wp.customize('load_design', (loadDesignSetting:any) => {\n            loadDesignSetting.bind((id:any) => {\n                \n                if( !themeIdIsValid(id) ) {\n                    return\n                }\n\n                handleLoadSettingChange(id)\n                .catch(error => {\n                    showNotification({\n                        setting: loadDesignSetting,\n                        code: \"loadDesignError\",\n                        message: error.message,\n                        type: 'error'\n                    })\n                    console.error(error.message)\n                })\n            })\n        });\n    });\n})();"],"names":[],"mappings":"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"}