var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});import{n as newEndpoint,N as NameSpace}from"../newEndpoint.C_IL8L5Q.js";const mediaSideload=newEndpoint({nameSpace:NameSpace.MUNICIPIO_V1,route:"media/sideload",method:"POST"}),isValidFileExtensionFromUrl=__name((url,extensions)=>{const fileName=url.substring(url.lastIndexOf("/")+1),fileExtensionsGroup=extensions.join("|");return new RegExp(`\\.(${fileExtensionsGroup})(\\?.+)?$`).test(fileName)},"isValidFileExtensionFromUrl"),isValidUrl=__name(test=>{try{if(new URL(test).origin==="null")return!1}catch{return!1}return!0},"isValidUrl"),isRemoteMediaFile=__name(url=>!(typeof url!="string"||!isValidUrl(url)||!isValidFileExtensionFromUrl(url,["svg"])),"isRemoteMediaFile"),valueIsHexString=__name(value=>typeof value=="string"&&value.indexOf("#")===0,"valueIsHexString"),scrubHexValue=__name(input=>{if(input)if(typeof input=="object")for(const[key,value]of Object.entries(input))valueIsHexString(value)&&(input[key]=value.toLowerCase());else valueIsHexString(input)&&(input=input.toLowerCase());return input},"scrubHexValue");async function handleMediaSideload(args){return mediaSideload.call(args).catch(error=>(console.error(error),null))}__name(handleMediaSideload,"handleMediaSideload");function getExcludedSections(){const defaultSections=["municipio_customizer_panel_design_module"],excludedSections=wp.customize.control("exclude_load_design").setting.get();return[...defaultSections,...excludedSections]}__name(getExcludedSections,"getExcludedSections");function getExcludedSettingIds(){const excludedSections=getExcludedSections();return Object.entries(wp.customize.settings.controls).map(([key])=>wp.customize.control(key)).filter(setting=>setting!==void 0).filter(setting=>setting.hasOwnProperty("params")).filter(setting=>excludedSections.includes(setting.params.section)).map(setting=>setting.id)}__name(getExcludedSettingIds,"getExcludedSettingIds");function getSettingsWithDefaultSetting(){const excludedSettingsIds=getExcludedSettingIds();return Object.entries(wp.customize.settings.settings).map(([key])=>wp.customize.control(key)).filter(setting=>setting!==void 0).filter(setting=>setting.hasOwnProperty("params")).filter(setting=>setting.params.hasOwnProperty("default")&&setting.params.hasOwnProperty("value")).filter(setting=>setting.params.type!=="kirki-custom").filter(setting=>!excludedSettingsIds.includes(setting.params.id))}__name(getSettingsWithDefaultSetting,"getSettingsWithDefaultSetting");function resetSettingsToDefault(settings){settings.forEach(setting=>{wp.customize.control(setting.id).setting.set(setting.params.default)})}__name(resetSettingsToDefault,"resetSettingsToDefault");function themeIdIsValid(id){return typeof id=="string"&&id.length===32}__name(themeIdIsValid,"themeIdIsValid");async function getRemoteSiteDesignData(id){return fetch(`https://customizer.municipio.tech/id/${id}`).then(response=>response.json()).catch(error=>{alert(error)})}__name(getRemoteSiteDesignData,"getRemoteSiteDesignData");async function migrateRemoteMediaFile(value,control=null){const sideloadedMedia=await handleMediaSideload({url:value,return:"src"});return control&&sideloadedMedia!==null&&control.setting.set(sideloadedMedia),sideloadedMedia}__name(migrateRemoteMediaFile,"migrateRemoteMediaFile");function updateKirkiImageControl(control,value){const img=document.querySelector(`.control-section-kirki-default ${control.selector} .attachment-thumb`);img!==null&&img.setAttribute("src",value)}__name(updateKirkiImageControl,"updateKirkiImageControl");function showNotification(args){const notification=new wp.customize.Notification(args.code,{message:args.message,type:args.type??"notice",dismissible:!0});args.setting.notifications.add(args.code,notification)}__name(showNotification,"showNotification");async function getFormattedMods(mods,excludedSettings){let formattedMods={};for(const[key,value]of Object.entries(mods))if(!excludedSettings.includes(key))if(value!==null&&typeof value=="object"&&!Array.isArray(value))for(const[subKey,subValue]of Object.entries(value))formattedMods[`${key}[${subKey}]`]=subValue;else formattedMods[key]=value;return formattedMods}__name(getFormattedMods,"getFormattedMods");async function importSettings(formattedMods,excludedSettings){for(const[key,rawValue]of Object.entries(formattedMods)){const control=wp.customize.control(key),value=Array.isArray(rawValue)?rawValue.filter(el=>el!==null):rawValue;if(!excludedSettings.includes(key)&&value!==null){if(key.startsWith("custom_fonts")){const fontName=key.match(/\[(.+)\]$/);if(fontName===null)continue;await handleMediaSideload({url:value,description:fontName[1],return:"id"})}else if(typeof control<"u")if(isRemoteMediaFile(value))await migrateRemoteMediaFile(value,control),updateKirkiImageControl(control,value);else{const scrubbedValue=scrubHexValue(value);control.setting.set(scrubbedValue)}}}}__name(importSettings,"importSettings");function findUrlsInString(string,origin){const urlRegex=/(?:(?:https?|ftp|file):\/\/|www\.|ftp\.)(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[-A-Z0-9+&@#/%=~_|$?!:,.])*(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[A-Z0-9+&@#/%=~_|$])/gi,foundFromRegex=string.match(urlRegex);if(foundFromRegex===null)return[];const validUrls=foundFromRegex.filter(isValidUrl);return origin?validUrls.filter(urlString=>{const url=new URL(urlString);return origin===url.origin}):validUrls}__name(findUrlsInString,"findUrlsInString");async function replaceRemoteFilesWithLocalInString(css,origin){const urls=findUrlsInString(css,origin);if(urls.length<1)return css;for(const url of urls){const migratedUrl=await migrateRemoteMediaFile(url);migratedUrl!==null&&(css=css.replace(url,migratedUrl))}return css}__name(replaceRemoteFilesWithLocalInString,"replaceRemoteFilesWithLocalInString");async function handleLoadSettingChange(id){const apiResponse=await getRemoteSiteDesignData(id);if(Object.keys(apiResponse.mods).length<1)throw new Error("The selected theme seems to be empty, please select another one.");const settingsWithDefaultSetting=getSettingsWithDefaultSetting(),excludedSettings=getExcludedSettingIds(),formattedMods=await getFormattedMods(apiResponse.mods,excludedSettings);if(resetSettingsToDefault(settingsWithDefaultSetting),importSettings(formattedMods,excludedSettings),!excludedSettings.includes("custom_css"))try{const dataUrl=new URL(apiResponse.website),sanitizedCss=await replaceRemoteFilesWithLocalInString(apiResponse.css??"",dataUrl.origin);wp.customize.control("custom_css").setting.set(sanitizedCss)}catch{throw new Error("Failed migrating css from source.")}}__name(handleLoadSettingChange,"handleLoadSettingChange");wp.customize&&wp.customize.bind("ready",()=>{wp.customize("load_design",loadDesignSetting=>{loadDesignSetting.bind(id=>{themeIdIsValid(id)&&handleLoadSettingChange(id).catch(error=>{showNotification({setting:loadDesignSetting,code:"loadDesignError",message:error.message,type:"error"}),console.error(error.message)})})})});
//# sourceMappingURL=design-share.Da_h9Wi6.js.map
